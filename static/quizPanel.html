<!DOCTYPE html>
<html>

<head>
    <title>ReTI Quiz</title>
    <meta charset="UTF-8">
</head>
<!--CSS-START-->
<link rel="stylesheet" type="text/css" href="quizPanel.css">
<!--CSS-END-->
<!--CSS-START-->
<link rel="icon" type="image/x-icon" href="favicon.ico">
<!--CSS-END-->
<body>
    <h1>&#x1f4a1ReTI Quiz</h1>
    <button id="button-reload" onclick="reloadQuiz()">Reload</button>
    <select class="custom-select" id="questionCountSelect" style="margin-left: 8px;" onchange="reloadQuiz()">
        <option value="1">1 Questions</option>
        <option value="5">5 Questions</option>
        <option value="10" selected>10 Questions</option>
        <option value="20">20 Questions</option>
    </select>
    <select class="custom-select" id="bitsImmediateSelect" style="margin-left: 8px;" onchange="reloadQuiz()">
        <option value="4">4 Bit</option>
        <option value="8">8 Bit</option>
        <option value="12">12 Bit</option>
        <option value="16">16 Bit</option>
        <option value="20">20 Bit</option>
        <option value="24" selected>24 Bit</option>
    </select>
    <div id="timer" style="margin-top: 10px;">Time: 00:00</div>
    <table id="quizTable" class="quiz-table">
        <tr>
            <th>Code</th>
            <th>Hexadecimal</th>
            <th>Result</th>
            <th></th>
        </tr>
    </table>
    <div>
        <h3>Explanation:</h3>
        <div id="explanation"></div>
    </div>
    <div id="completionMessage"></div>
    <script type="module">
        /*/IMPORTS/*/
        import { randomInstruction, decodeInstruction, hexToBin, binToHex } from './reti.js';
        /*/IMPORTS-END/*/

        let questionsAnswered = 0;
        let correctAnswers = 0;
        let numQuestions = document.getElementById('questionCountSelect').value;
        let startTime;
        let timerInterval;
        let finished = false;
        let firstLoad = true;

        function reloadQuiz() {
            const quizTable = document.getElementById('quizTable');
            numQuestions = document.getElementById('questionCountSelect').value;
            while (quizTable.rows.length > 1) {
                quizTable.deleteRow(1);
            }
            finished = false;
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            generateQuizRows(numQuestions);
            document.getElementById('timer').innerText = `Time: 00:00`;

            correctAnswers = 0;
            questionsAnswered = 0;

            const explanationDiv = document.getElementById('explanation');
            explanationDiv.innerHTML = '';
            const completionMessage = document.getElementById('completionMessage');
            completionMessage.innerHTML = '';

        }
        window.reloadQuiz = reloadQuiz;

        function updateTimer() {
            if (!startTime || finished) {
                return;
            }

            const currentTime = new Date().getTime();
            const elapsedTime = currentTime - startTime;
            const minutes = Math.floor(elapsedTime / 60000);
            const seconds = Math.floor((elapsedTime % 60000) / 1000);

            document.getElementById('timer').innerText = `Time: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function checkAnswer(rowIndex, correctValue, explanation) {
            const inputElement = document.getElementById(`missingChar-${rowIndex}`);
            const input = inputElement.innerText.trim();
            const resultCell = document.getElementById(`result-${rowIndex}`);
            const explanationDiv = document.getElementById('explanation');
            const checkButton = document.getElementById(`check-button-${rowIndex}`);

            if (input.toLowerCase() === correctValue.toLowerCase()) {
                resultCell.innerHTML = '<span style="color: green;">&#10004;</span>';
                explanationDiv.innerText = 'Correct! ';
                explanationDiv.appendChild(explanation);
                if (inputElement.contentEditable == "true") {
                    correctAnswers++;
                }
            } else {
                resultCell.innerHTML = '<span style="color: red;">&#10060;</span>';
                explanationDiv.innerText = 'Incorrect! ' + `The correct value was: ${correctValue}. \n`;
                explanationDiv.appendChild(explanation);

            }
            if (inputElement.contentEditable == "true") {
                questionsAnswered++;
                document.getElementById(`missingChar-${rowIndex}`).contentEditable = "false";
            }

            if (questionsAnswered >= numQuestions) {
                finished = true;
                const currentTime = Date.now();
                const elapsedTime = (currentTime - startTime) / 1000;
                const minutes = Math.floor(elapsedTime / 60);
                const seconds = Math.floor(elapsedTime % 60);
                document.getElementById('completionMessage').innerText = `Quiz completed in ${minutes} minutes and ${seconds} seconds. You answered ${correctAnswers} out of ${numQuestions} questions correctly.`;
            }
        }

        function generateQuizRows(numQuestions) {
            const quizTable = document.getElementById('quizTable');
            const questions = [];

            for (let i = 0; i < numQuestions; i++) {
                const row = document.createElement('tr');
                const instruction = randomInstruction();
                const [code, explanation] = decodeInstruction(instruction);

                const codehex = binToHex(instruction).toUpperCase();
                // Using this out of lazinesss since it is already correctly formatted this way.
                const binaryString = hexToBin(codehex);
                const formattedBinary = binaryString.replace(/(.{4})/g, '$1_').slice(0, -1);
                const missingIndex = Math.floor(Math.random() * codehex.length);
                const hexWithGap = codehex.slice(0, missingIndex) + `<span id="missingChar-${i}" class="editable" contenteditable="true"></span>` + codehex.slice(missingIndex + 1);

                const explanationTable = document.createElement('table');
                explanationTable.classList.add("table-explanation");

                const header = document.createElement('tr');
                for (let i = 0; i < explanation.length; i++) {
                    const th = document.createElement('th');
                    th.innerText = explanation[i][0];
                    th.colSpan = explanation[i][1] % 5;
                    header.appendChild(th);
                }
                explanationTable.appendChild(header);

                const explRow = document.createElement('tr');
                for (let i = 0; i < explanation.length; i++) {
                    const td = document.createElement('td');
                    td.innerText = explanation[i][2];
                    td.colSpan = explanation[i][1] % 5;
                    explRow.appendChild(td);
                }
                explanationTable.appendChild(explRow);

                const binaryRow = document.createElement('tr');
                for (let i = 0; i < 9; i++) {
                    const td = document.createElement('td');
                    if (i === 8) {
                        td.innerText = binaryString.slice(i);
                        td.colSpan = 4;
                    }
                    else {
                        td.innerText = binaryString[i];
                    }
                    td.className = 'bin-column';
                    binaryRow.appendChild(td);
                }
                explanationTable.appendChild(binaryRow);

                const hexRow = document.createElement('tr');
                for (let i = 0; i < 3; i++) {
                    const td = document.createElement('td');
                    if (i === 2) {
                        td.innerText = codehex.slice(i);
                    }
                    else {
                        td.innerText = codehex[i];
                    }
                    td.className = 'bin-column';
                    td.colSpan = 4;
                    hexRow.appendChild(td);
                }
                explanationTable.appendChild(hexRow);

                const codeRow = document.createElement('tr');
                const codeRowInput = document.createElement('td');
                codeRowInput.colSpan = 12;
                codeRowInput.innerText = code;
                codeRowInput.style.verticalAlign = 'middle';
                codeRow.appendChild(codeRowInput);
                explanationTable.appendChild(codeRow);



                const codeCell = document.createElement('td');
                codeCell.innerText = code;
                codeCell.classList.add('code-cell');
                row.appendChild(codeCell);

                const hexCell = document.createElement('td');
                hexCell.classList.add('hex-cell');
                hexCell.innerHTML = hexWithGap;
                row.appendChild(hexCell);

                const resultCell = document.createElement('td');
                resultCell.id = `result-${i}`;
                resultCell.classList.add('result-cell');
                row.appendChild(resultCell);

                const checkButtonCell = document.createElement('td');
                const checkButton = document.createElement('button');
                checkButton.id = `check-button-${i}`;
                checkButton.classList.add('check-button');
                checkButton.innerText = 'Check';
                checkButton.onclick = () => checkAnswer(i, codehex[missingIndex], explanationTable);
                checkButtonCell.appendChild(checkButton);
                row.appendChild(checkButtonCell);

                quizTable.appendChild(row);
            }
        }

        window.onload = function () {
            if (firstLoad) {
                firstLoad = false;
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);
                generateQuizRows(numQuestions);
            }
        };

        function restrictInput(index){
            let inputElement = document.getElementById(`missingChar-${i}`);
            let currText = inputElement.innerText.trim();

            if (currText.length() > 1) {
                inputElement.innerText = currText.charAt(0);
            }
        }
    </script>
</body>

</html>